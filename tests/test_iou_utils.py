import pytest
import numpy as np

from deep_sort.geometry.iou_utils import iou


@pytest.mark.parametrize("bbox,candidates,expected_iou", [
    ([22, 93, 195, 17], [[57., 74., 154., 81.]], [0.19877003]),

    ([88, 58, 46, 169], [[46., 79., 184., 142.], [64., 43., 98., 137.], [69., 42., 102., 146.]],
     [0.23865546, 0.36002053, 0.35838427]),

    ([58, 83, 73, 90], [[62., 39., 55., 188.]], [0.4138796]),

    ([91, 35, 97, 162], [[72., 64., 74., 23.], [62., 77., 16., 114.], [70., 16., 104., 167.], [66., 82., 108., 70.]],
     [0.07832332, 0., 0.59063371, 0.33268438]),

    ([76, 37, 165, 194], [[75., 82., 122., 10.], [16., 50., 166., 110.]], [0.03778888, 0.3019943]),

    ([25, 24, 124, 54], [[59., 98., 98., 10.], [24., 14., 28., 21.], [41., 32., 108., 197.]],
     [0., 0.04250751, 0.21596244]),

    ([98, 10, 159, 48], [[90., 64., 30., 88.], [13., 94., 182., 184.], [53., 74., 96., 104.]], [0., 0., 0.]),
    ([91, 34, 49, 165], [[93., 33., 119., 74.]], [0.25490342]),

    ([32, 97, 145, 187], [[20., 78., 27., 55.]], [0.01924448]),

    ([52, 43, 124, 75], [[71., 24., 190., 100.], [51., 90., 166., 124.], [22., 90., 30., 196.]],
     [0.38555692, 0.1314554, 0.]),
])
def test_initIOU_randomBboxAndCandidates_returnsCorrectMetric(bbox, candidates, expected_iou):
    assert (abs(iou(np.array(bbox), np.array(candidates)) - expected_iou) < 1e-5).all()
