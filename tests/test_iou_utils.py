import pytest

from src.utils.geometry.iou_utils import iou
from src.utils.geometry.rect import Rect


@pytest.mark.parametrize("bbox,candidates,expected_iou", [
    ([22, 93, 195, 17], [[57., 74., 154., 81.]], [0.18349449066786597]),

    ([88, 58, 46, 169], [[46., 79., 184., 142.], [64., 43., 98., 137.], [69., 42., 102., 146.]],
     [0.23025002721631527, 0.3456045699777848, 0.3442856295593381]),

    ([58, 83, 73, 90], [[62., 39., 55., 188.]], [0.39705882352941174]),

    ([91, 35, 97, 162], [[72., 64., 74., 23.], [62., 77., 16., 114.], [70., 16., 104., 167.], [66., 82., 108., 70.]],
     [0.07320680305644565, 0.0, 0.5732356857523302, 0.32118528610354224]),

    ([76, 37, 165, 194], [[75., 82., 122., 10.], [16., 50., 166., 110.]], [0.03359253499222395, 0.29478428847392146]),

    ([25, 24, 124, 54], [[59., 98., 98., 10.], [24., 14., 28., 21.], [41., 32., 108., 197.]],
     [0.0, 0.037015945330296125, 0.2079284881461329]),

    ([98, 10, 159, 48], [[90., 64., 30., 88.], [13., 94., 182., 184.], [53., 74., 96., 104.]], [0., 0., 0.]),
    ([91, 34, 49, 165], [[93., 33., 119., 74.]], [0.24390603137197142]),

    ([32, 97, 145, 187], [[20., 78., 27., 55.]], [0.017431519032372823]),

    ([52, 43, 124, 75], [[71., 24., 190., 100.], [51., 90., 166., 124.], [22., 90., 30., 196.]],
     [0.37351970491166764, 0.12502352896886648, 0.0]),
])
def test_initIOU_randomBboxAndCandidates_returnsCorrectMetric(bbox, candidates, expected_iou):
    rect_bbox = Rect.from_tlwh(bbox)
    rect_candidates = [Rect.from_tlwh(candidate) for candidate in candidates]
    assert (abs(iou(rect_bbox, rect_candidates) - expected_iou) < 1e-5).all()
